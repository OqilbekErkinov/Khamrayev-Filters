name: CI/CD with Telegram Notification

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get commit information
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' | sed 's/[_*\[\]()~`>#\+=|{}.!]/\\&/g')
          COMMIT_DATE=$(git log -1 --pretty=format:'%ci')
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          REPO_NAME=${{ github.repository }}
          COMMIT_URL="https://github.com/$REPO_NAME/commit/$COMMIT_HASH"
          GITHUB_ACTOR="${{ github.actor }}"

          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV
          echo "GITHUB_ACTOR=$GITHUB_ACTOR" >> $GITHUB_ENV

      - name: Serverga ulanish va pull qilish
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo -i << 'EOF'
            cd /var/www/Khamrayev-Filters

            # Git konfiguratsiyasi
            git fetch origin main
            git reset --hard origin/main  # Yangilash va eski kodlarni inkor qilish

            # Build jarayonini bajarish
            npm run build  # Faqat build qilish

            # PM2 ni yangilash
            pm2 restart all  # PM2 orqali xizmatni yangilash

            # Nginxni qayta ishga tushirish
            sudo systemctl restart nginx  # Nginxni qayta ishga tushirish
            EOF

      - name: Send notification to Telegram
        run: |
         curl -X POST "https://api.telegram.org/bot7399847827:AAG5tD_qQU8qIktxVMRMkHoWZENLRU9HnQ4/sendMessage" \
         -d "chat_id=-1002289045305" \
         -d parse_mode="HTML" \
         --data-urlencode "text=<b>ğŸ“¢ KhamrayevFilters Frontend Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸!</b>%0A\
         %0A\
         <b>ğŸ“Œ ĞĞ²Ñ‚Ğ¾Ñ€:</b> ${{ env.GITHUB_ACTOR }}%0A\
         <b>ğŸŒ¿ Ğ’ĞµÑ‚ĞºĞ°:</b> ${{ env.BRANCH_NAME }}%0A\
         <b>ğŸ“ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°:</b> ${{ env.COMMIT_MESSAGE }}%0A\
         <b>ğŸ“… Ğ”Ğ°Ñ‚Ğ°:</b> ${{ env.COMMIT_DATE }}%0A\
         <b>ğŸ”— <a href='${{ env.COMMIT_URL }}'>ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°</a></b>%0A\
         %0A\
         <b>âœ… KhamrayevFilters Frontend ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ!</b>%0A\
         <b>ğŸ”„ ĞšĞ¾Ğ´ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ</b>%0A\
         <b>ğŸ”— <a href='https://github.com/${{ github.repository }}'>ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ</a></b>"