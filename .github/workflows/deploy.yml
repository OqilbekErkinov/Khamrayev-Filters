name: Deploy to Server

on:
  push:
    branches:
      - main  # Faqat 'main' branch push qilinganda ishga tushadi

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Serverga ulanish va pull qilish
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo -i << 'EOF'
            cd /var/www/Khamrayev-Filters

            # Git konfiguratsiyasi
            git fetch origin main
            git reset --hard origin/main  # Yangilash va eski kodlarni inkor qilish

            # Build jarayonini bajarish
            npm run build  # Faqat build qilish

            # PM2 ni yangilash
            pm2 restart all  # PM2 orqali xizmatni yangilash

            # Nginxni qayta ishga tushirish
            sudo systemctl restart nginx  # Nginxni qayta ishga tushirish
            EOF

      - name: Send notification to Telegram after deployment
        run: |
          curl -X POST "https://api.telegram.org/bot739984782txVMRMkHoWZENLRU9HnQ4/sendMessage" \
          -d "chat_id=-you chat id" \
          -d "parse_mode=MarkdownV2" \
          -d "text=âœ… *KhamrayevFilters Frontend Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€e Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾\!*%0A%0A\
          ðŸ”„ *ÐšÐ¾Ð´ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ*%0A\
          ðŸ“Œ *Ð’ÐµÑ‚ÐºÐ°:* \`${{ github.ref_name }}\`%0A\
          ðŸ”— [ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ](https://github.com/${{ github.repository }})"
